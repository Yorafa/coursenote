"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8951],{5806:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var t=i(5893),s=i(1151);const l={},a="File System Reliability",r={id:"csc/csc369/10 file system reliability",title:"File System Reliability",description:"We need to consider the onsistency issues about fs.",source:"@site/docs/csc/csc369/10 file system reliability.md",sourceDirName:"csc/csc369",slug:"/csc/csc369/10 file system reliability",permalink:"/docs/csc/csc369/10 file system reliability",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"File System",permalink:"/docs/csc/csc369/09 file system introduction"},next:{title:"CSC413 Neural Networks and Deep Learning",permalink:"/docs/csc/csc413/"}},o={},c=[{value:"Approaches to Consistency",id:"approaches-to-consistency",level:2},{value:"Detect and Repair Solution",id:"detect-and-repair-solution",level:3},{value:"Journaling Solution",id:"journaling-solution",level:3}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"file-system-reliability",children:"File System Reliability"}),"\n",(0,t.jsx)(n.p,{children:"We need to consider the onsistency issues about fs."}),"\n",(0,t.jsx)(n.p,{children:"fs operations affect multiple metadata blocks where as we create a file, we modify the inode bitmap, and also initilize an inode structure. but what if we power off suddenly?"}),"\n",(0,t.jsx)(n.p,{children:"Let's firstly look at how fs work:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["create root directory","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"we modify data bitmap, inode bitmap, inode table, data blocks"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["create a empty file","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"we modify inode bitmap, inode table, data blocks(parent directory's data block)"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["append to a file","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"we modify inode table, data bitmap, data blocks"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"our goal: ensure that the file system metadata is in a consistent state following an operation system. We define consistency state as it either looks like a file operation never happened, or it looks like the operation completed successfully."}),"\n",(0,t.jsx)(n.p,{children:"now some crash happen, e.g. append to a file, three writes are needed, let's say I[2], D[3], data bitmap."}),"\n",(0,t.jsx)(n.p,{children:"The crash happened when only 1 write succeed:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["just D[3] write succeeds:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"no inode no data bitamp -> as if the write did not occur"}),"\n",(0,t.jsx)(n.li,{children:"fs not inconsistent but data is lost"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["just I[2] (inode) write succeeds:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"No data block -> will read garbage data from disk."}),"\n",(0,t.jsx)(n.li,{children:"No bitmap entry, but inode has a pointer to D[3] -> FS inconsistency!"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["just Data Bitmap write succeeds.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Bitmap says D[3] is allocated, inode has no pointer to it"}),"\n",(0,t.jsx)(n.li,{children:"fs inconsistent + D[3] contains garbage"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"only 2 writes succeed:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["only I[2] and data bitmap writes succeed","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"inode and data bitmap agree -> fs metadata is consistent"}),"\n",(0,t.jsx)(n.li,{children:"D[3] contains garbage"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["only i[2] and D[3] writes succeed","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"inode points to correct data, but ids agrees with data bitmap (D[3] is free)"}),"\n",(0,t.jsx)(n.li,{children:"fs inconsistency must be fixed"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Only Data Bitmap and D[3] writes succeed.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Again, inode and bitmap info does not match"}),"\n",(0,t.jsx)(n.li,{children:"Even though D[3] was written, no inode points to it."}),"\n",(0,t.jsx)(n.li,{children:"fs inconsistency"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"approaches-to-consistency",children:"Approaches to Consistency"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Uninterruptible power supply (UPS):","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"disable incoming file system write requests after power failure"}),"\n",(0,t.jsx)(n.li,{children:"use UPS to buy time for a clean shutddown"}),"\n",(0,t.jsx)(n.li,{children:"doesn't help if failure is due to system crash"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["do nothing during normal operation. Try to recover to a consistent state in the event of a crash(detect and repair)","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"order the writes that make up an opertaion to minimize data loss"}),"\n",(0,t.jsx)(n.li,{children:"most older file systems used this (i.e. ffs, ext2)."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["treat each file system operation as a transcation (journal)","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"prevent, or roll-back any changes from uncompleted transactions"}),"\n",(0,t.jsx)(n.li,{children:"replay, or roll-forward any changes from completed but incompletely written transactions"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"detect-and-repair-solution",children:"Detect and Repair Solution"}),"\n",(0,t.jsx)(n.p,{children:"When the file system comes back up, run a program to scan the file system structure and restore consistency."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"fsck"}),"- file system check:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"UNIX tool for finding inconsistencies and repairing them"}),"\n",(0,t.jsx)(n.li,{children:"similar tools exist on other systems"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"It checks:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Superblock"}),"\n",(0,t.jsx)(n.li,{children:"free blocks"}),"\n",(0,t.jsx)(n.li,{children:"inode state"}),"\n",(0,t.jsx)(n.li,{children:"inode links"}),"\n",(0,t.jsx)(n.li,{children:"Duplicates: check if two different indoes refer to the same block."}),"\n",(0,t.jsx)(n.li,{children:"Bad blocks"}),"\n",(0,t.jsx)(n.li,{children:"Directory checks"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"cons: cannot fix all problems"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"only verifies/ensures that file system metadata is consistent"}),"\n",(0,t.jsx)(n.li,{children:"poor at detecting/fixing data block corruption"}),"\n",(0,t.jsx)(n.li,{children:"too slow since it doesn't know what you did before so that might need to scan whole fs"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"example consistency rules(it's incomplete list!)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"all data blocks pointed to by inodes (and indirect blocks) must be marked allocated in the data bitmap"}),"\n",(0,t.jsx)(n.li,{children:"no allocated data block can be pointed to more than once"}),"\n",(0,t.jsx)(n.li,{children:"all allocated inodes must be in some directory entry"}),"\n",(0,t.jsx)(n.li,{children:"inode link count must match number of idrectory entreis"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"journaling-solution",children:"Journaling Solution"}),"\n",(0,t.jsx)(n.p,{children:"We also call journaling solution as wrtie ahead logging. It basicaly write a log on disk of the operation you are about to do, before aking changes in actual fs."}),"\n",(0,t.jsx)(n.p,{children:"If a crash takes place during the actual write, on recovery, go to journal and retry actual writes."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"don't need to scan the entiredisk anymore"}),"\n",(0,t.jsx)(n.li,{children:"also can recover the data"}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"exmaple: EXt3 fs of Linux\nIt extends ext2 with journaling capabilities:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"backwards and forwards compatible on identical on-disk format"}),"\n",(0,t.jsx)(n.li,{children:"journal can be just another large file (inode, indirect blocks data blocks)"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"what exactly goes in to the log? the transaction structure! it"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"starts with a transcation begin block containing a transcation ID"}),"\n",(0,t.jsx)(n.li,{children:"folowed by blocks with the content to be written . Physically: log exact physical content. Logically: log more compact logical representation."}),"\n",(0,t.jsx)(n.li,{children:"Ends with a transcation end block, containing the corresponding TID"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"e.g. let's say we have a regular update : add 1 data block to a file:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"write inode, data bitmap, data block"}),"\n",(0,t.jsxs)(n.li,{children:["markers for the log","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Journal entry: | TxBegin | Updated inode | updated bitmap | updated data block | TxEnd |"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["We have following sequence of opertaions:","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"write the transaction (containing ...) to the log"}),"\n",(0,t.jsx)(n.li,{children:"write the blocks to the fs"}),"\n",(0,t.jsx)(n.li,{children:"mark the transaction free in the journal."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"if crash happen around step 2 or 3, we just redo the transcation. But if happened while step 1, it become complicated. To avoid this, split the transaction logging into 2 steps using a barrier."}),"\n",(0,t.jsx)(n.p,{children:"Then we have following sequence of opertaions:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"write all blocks except TxEnd to journal (Journal write step)"}),"\n",(0,t.jsx)(n.li,{children:"Write TxEnd after Step 1 completes (Journal commit step) -> final state is safe"}),"\n",(0,t.jsx)(n.li,{children:"finally, now that the journal entry is safe, write the actual data and metadata to their correct locations in the fs (checkpoint step)"}),"\n",(0,t.jsx)(n.li,{children:"mark transaction as free in journal (Free step)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"1 -> 2 with barrier and 2 -> 3 also with barrier, then we have:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"if crash happened before transaction commit, skip the pending update"}),"\n",(0,t.jsx)(n.li,{children:"if crash happened during checkpoint, scan and redo the transaction (call redo log)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"We implement the journaling solution by simply adding a file to the file system that contains the journal, but make it circular."}),"\n",(0,t.jsx)(n.p,{children:"cons: journaling is not a panacea"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"slow: need to write to disk twice for each operation"}),"\n",(0,t.jsx)(n.li,{children:"may break sequential writing (i.e. back-forth writing data and journal)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["enhanced journaling(only record metadata) called ",(0,t.jsx)(n.strong,{children:"metadata journaling"}),":"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Write data, wait until it completes"}),"\n",(0,t.jsx)(n.li,{children:"Metadata journal write"}),"\n",(0,t.jsx)(n.li,{children:"Metadata journal commit"}),"\n",(0,t.jsx)(n.li,{children:"Checkpoint metadata"}),"\n",(0,t.jsx)(n.li,{children:"Free transaction"}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"if write data fails, we just skip as nothing happened"}),"\n",(0,t.jsx)(n.li,{children:"if write metadata fails, we redo the transaction"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},1151:(e,n,i)=>{i.d(n,{Z:()=>r,a:()=>a});var t=i(7294);const s={},l=t.createContext(s);function a(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);